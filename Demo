CREATE OR REPLACE VIEW V_SR_ACT_CERTIFICATIONXXXX (
    ACTIVITY_KEY,
    CERT_EXP_DATE,
    CERT_EXP_DAY,
    CERT_EXP_MONTH,
    CERT_EXP_YEAR,
    CERT_NUMOF_EXP_DAYS
) AS

SELECT 
    P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ACTIVITY.activity_pk AS activity_key,
    DECODE(
        P2L_BO_STAGING_OWNER.CLD_TBL_TMX_REQUIREDACTIVI.expirationrule,
        0, 'Never Expire',
        1, TO_CHAR(P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT.expirationdate, 'MM-DD-YYYY'),
        2, TO_CHAR(P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT.expirationdate, 'MM-DD-YYYY'),
        3, TO_CHAR(P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT.expirationdate, 'MM-DD-YYYY')
    ) AS cert_exp_date,

    DECODE(
        P2L_BO_STAGING_OWNER.CLD_TBL_TMX_REQUIREDACTIVI.expirationrule,
        0, 'Never Expire',
        1, UPPER(DAYNAME(P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT.expirationdate)),
        2, UPPER(DAYNAME(P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT.expirationdate)),
        3, UPPER(DAYNAME(P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT.expirationdate))
    ) AS cert_exp_day,

    DECODE(
        P2L_BO_STAGING_OWNER.CLD_TBL_TMX_REQUIREDACTIVI.expirationrule,
        0, 'Never Expire',
        1, UPPER(TO_CHAR(P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT.expirationdate, 'MON')),
        2, UPPER(TO_CHAR(P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT.expirationdate, 'MON')),
        3, UPPER(TO_CHAR(P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT.expirationdate, 'MON'))
    ) AS cert_exp_month,

    DECODE(
        P2L_BO_STAGING_OWNER.CLD_TBL_TMX_REQUIREDACTIVI.expirationrule,
        0, 'Never Expire',
        1, TO_CHAR(P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT.expirationdate, 'YYYY'),
        2, TO_CHAR(P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT.expirationdate, 'YYYY'),
        3, TO_CHAR(P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT.expirationdate, 'YYYY')
    ) AS cert_exp_year,

    DECODE(
        P2L_BO_STAGING_OWNER.CLD_TBL_TMX_REQUIREDACTIVI.expirationrule,
        1, P2L_BO_STAGING_OWNER.CLD_TBL_TMX_REQUIREDACTIVI.expirationparamvalue
    ) AS cert_numof_exp_days

FROM 
    P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ACTIVITY
LEFT JOIN 
    P2L_BO_STAGING_OWNER.CLD_TBL_TMX_REQUIREDACTIVI 
    ON P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ACTIVITY.activity_pk = P2L_BO_STAGING_OWNER.CLD_TBL_TMX_REQUIREDACTIVI.activityfk
LEFT JOIN 
    P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT 
    ON P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ACTIVITY.activity_pk = P2L_BO_STAGING_OWNER.CLD_TBL_TMX_ATTEMPT.activityfk;
