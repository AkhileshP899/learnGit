WITH LatestMetadata AS (
    SELECT metadatafk,
           metadatakey,
           metadatavalue,
           IDENTIFIER,
           ROW_NUMBER() OVER (PARTITION BY metadatafk, metadatakey ORDER BY IDENTIFIER DESC) AS rn
      FROM P2L_BO_STAGING_OWNER.CLD_CNTMDATA_EX
)
SELECT m.metadatafk,
       MAX(CASE WHEN a.metadatakey = 'stringelement' THEN a.metadatavalue END) AS activity_sponsors,
       MAX(CASE WHEN a.metadatakey = 'stringelement2' THEN a.metadatavalue END) AS act_experts,
       MAX(CASE WHEN a.metadatakey = 'stringelement3' THEN a.metadatavalue END) AS activity_reviewers,
       MAX(CASE WHEN a.metadatakey = 'stringelement4' THEN a.metadatavalue END) AS act_train_representatives,
       MAX(CASE WHEN a.metadatakey = 'stringelement5' THEN a.metadatavalue END) AS review_outcome,
       MAX(CASE WHEN a.metadatakey = 'stringelement6' THEN a.metadatavalue END) AS notes,
       MAX(CASE WHEN a.metadatakey = 'dateelement' THEN a.metadatavalue END) AS review_date,
       MAX(CASE WHEN a.metadatakey = 'dateelement2' THEN a.metadatavalue END) AS next_review_date
  FROM P2L_BO_STAGING_OWNER.CLD_CNTMDATA_EX m
  LEFT JOIN LatestMetadata a
    ON a.metadatafk = m.metadatafk
   AND a.rn = 1
 GROUP BY m.metadatafk;
